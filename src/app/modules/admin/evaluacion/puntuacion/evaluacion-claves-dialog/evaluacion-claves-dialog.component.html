<h2 mat-dialog-title>Claves de evaluación</h2>

<mat-dialog-content>
  <div class="space-y-4">
    <div class="text-sm text-gray-600">
      Gestiona las respuestas para las preguntas del rango
      <span class="font-medium text-gray-800">{{ detalle.rangoInicio }}</span>
      al
      <span class="font-medium text-gray-800">{{ detalle.rangoFin }}</span>.
    </div>

    @if (isLoading$ | async) {
      <div class="flex justify-center py-6">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    } @else {
      <form [formGroup]="form" class="space-y-4">
        <div formArrayName="claves">
          @if (clavesForm.length === 0) {
            <div
              class="flex h-48 items-center justify-center rounded border border-dashed border-gray-300 bg-gray-50 px-6 text-center text-sm text-gray-500">
              No hay claves registradas para el rango configurado.
            </div>
          } @else {

            <!-- MatTable reescrita con <table mat-table> -->
            <table mat-table [dataSource]="clavesForm.controls"
                   class="mat-elevation-z0 w-full overflow-hidden rounded border border-gray-200 my-mat-table">

              <!-- Columnas generadas con @for -->
              @for (col of displayedColumns; track col) {
                <ng-container [matColumnDef]="col">
                  <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    {{ headerMap[col] }}
                  </th>

                  <td mat-cell *matCellDef="let group; let rowIndex = index" class="px-4 py-2">
                    <ng-container [formGroup]="group">

                      @if (col === columnas.PreguntaOrden) {
                        <mat-form-field appearance="outline" class="w-32">
                          <mat-label>Orden</mat-label>
                          <input
                            #ordenInput
                            matInput
                            type="number"
                            formControlName="preguntaOrden"
                            (focus)="setActiveRow(rowIndex)"
                            (keydown.enter)="onOrdenEnter($event, rowIndex)"
                          />
                          @if (group.controls.preguntaOrden.invalid && (group.controls.preguntaOrden.dirty || group.controls.preguntaOrden.touched)) {
                            <mat-error>Ingresa un número válido.</mat-error>
                          }
                        </mat-form-field>
                      } @else if (col === columnas.Respuesta) {
                        <mat-form-field appearance="outline" class="w-28">
                          <mat-label>Respuesta (A–H)</mat-label>
                          <input
                            #respuestaInput
                            matInput
                            type="text"
                            inputmode="latin"
                            maxlength="1"
                            autocomplete="off"
                            autocapitalize="characters"
                            formControlName="respuesta"
                            (focus)="setActiveRow(rowIndex)"
                            (keydown)="onRespuestaKeydown($event)"
                            (input)="onRespuestaInput($event, rowIndex)"
                            (keydown.enter)="onRespuestaEnter($event, rowIndex)"
                          />
                          @if (group.controls.respuesta.invalid && (group.controls.respuesta.dirty || group.controls.respuesta.touched)) {
                            <mat-error>Solo letras A–H.</mat-error>
                          }
                        </mat-form-field>
                      }

                    </ng-container>
                  </td>
                </ng-container>
              }

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row
                  *matRowDef="let row; let rowIndex = index; columns: displayedColumns"
                  [class.is-active-row]="activeRowIndex === rowIndex">
              </tr>
            </table>

          }
        </div>
      </form>
    }
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="gap-2">
  <button mat-button type="button" (click)="cancel()">Cancelar</button>
  <button
    mat-flat-button
    color="primary"
    type="button"
    (click)="save()"
    [disabled]="isSaving$ | async">
    Guardar
  </button>
</mat-dialog-actions>
