<h2 mat-dialog-title>{{ dialogTitle }}</h2>

<form [formGroup]="form" class="evaluacion-dialog" (ngSubmit)="submitForm()">
  <mat-dialog-content>
    <div class="evaluacion-dialog__grid">
      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" maxlength="150" autocomplete="off" />
        <mat-hint align="end">{{ form.controls['nombre'].value?.length || 0 }}/150</mat-hint>
        @if (form.controls['nombre'].hasError('required')) {
          <mat-error>
            El nombre es obligatorio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de evaluación</mat-label>
        <mat-select formControlName="tipoEvaluacionId">
          @for (tipo of tipoEvaluaciones$ | async; track tipo) {
            <mat-option [value]="tipo.id">
              {{ tipo.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (form.controls['tipoEvaluacionId'].hasError('required')) {
          <mat-error>
            Selecciona un tipo de evaluación.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sede</mat-label>
        <mat-select formControlName="sedeId">
          @for (sede of sedes$ | async; track sede) {
            <mat-option [value]="sede.id">
              {{ sede.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (form.controls['sedeId'].hasError('required')) {
          <mat-error>
            Selecciona una sede.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Ciclo</mat-label>
        <mat-select formControlName="cicloId">
          @for (ciclo of filteredCiclos$ | async; track ciclo) {
            <mat-option [value]="ciclo.id">
              {{ ciclo.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (isLoadingCiclos$ | async) {
          <div class="evaluacion-dialog__loading">
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Cargando ciclos...</span>
          </div>
        }
        @if (form.controls['cicloId'].hasError('required')) {
          <mat-error>
            Selecciona un ciclo válido.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de inicio</mat-label>
        <input matInput [matDatepicker]="fechaInicioPicker" formControlName="fechaInicio" />
        <mat-datepicker-toggle matSuffix [for]="fechaInicioPicker"></mat-datepicker-toggle>
        <mat-datepicker #fechaInicioPicker></mat-datepicker>
        @if (form.controls['fechaInicio'].hasError('required')) {
          <mat-error>
            Selecciona una fecha de inicio.
          </mat-error>
        }
        @if (form.controls['fechaInicio'].hasError('fechaDuplicada')) {
          <mat-error>
            Ya existe una evaluación programada con esta fecha y ciclo.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hora de inicio</mat-label>
        <input matInput type="time" formControlName="horaInicio" />
        @if (form.controls['horaInicio'].hasError('required')) {
          <mat-error>
            Ingresa la hora de inicio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hora de fin</mat-label>
        <input matInput type="time" formControlName="horaFin" />
        @if (form.controls['horaFin'].hasError('required')) {
          <mat-error>
            Ingresa la hora de fin.
          </mat-error>
        }
        @if (form.hasError('horarioInvalido')) {
          <mat-error>
            La hora de fin debe ser mayor a la hora de inicio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Carrera (opcional)</mat-label>
        <mat-select formControlName="carreraId">
          <mat-option [value]="null">Sin carrera</mat-option>
          @for (carrera of carreras$ | async; track carrera) {
            <mat-option [value]="carrera.id">
              {{ carrera.nombre }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="evaluacion-dialog__toggle">
        <mat-slide-toggle formControlName="activo">Activo</mat-slide-toggle>
      </div>
    </div>

    <mat-divider></mat-divider>

    <div class="evaluacion-dialog__sections">
      <div class="evaluacion-dialog__sections-header">
        <h3>Secciones</h3>
        @if (isLoadingSecciones$ | async) {
          <div class="evaluacion-dialog__sections-loader">
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Cargando secciones disponibles…</span>
          </div>
        }
      </div>

      <div class="evaluacion-dialog__sections-grid">
        <section class="evaluacion-dialog__list" aria-labelledby="secciones-disponibles">
          <header class="evaluacion-dialog__list-header">
            <h4 id="secciones-disponibles">Secciones disponibles</h4>
          </header>
          <div class="evaluacion-dialog__list-body">
            @let available = availableSeccionOptions$ | async;
            @if ((available?.length ?? 0) === 0) {
              <p class="evaluacion-dialog__list-empty">
                No hay secciones adicionales para agregar.
              </p>
            } @else {
              <ul class="evaluacion-dialog__items" role="list">
                @for (option of available; track option.seccionCicloId) {
                  <li class="evaluacion-dialog__item" role="listitem">
                    <div class="evaluacion-dialog__item-info">
                      <span class="evaluacion-dialog__item-title">{{ option.label }}</span>
                      @if (!option.activo) {
                        <span class="evaluacion-dialog__chip evaluacion-dialog__chip--inactive">
                          Inactiva en el ciclo
                        </span>
                      }
                    </div>
                    <div class="evaluacion-dialog__item-actions">
                      <button
                        mat-icon-button
                        color="primary"
                        type="button"
                        (click)="addSeccion(option)"
                        [disabled]="isSaving$ | async"
                        aria-label="Agregar sección"
                      >
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                  </li>
                }
              </ul>
            }
          </div>
        </section>

        <section class="evaluacion-dialog__list" aria-labelledby="secciones-seleccionadas">
          <header class="evaluacion-dialog__list-header">
            <h4 id="secciones-seleccionadas">Secciones seleccionadas</h4>
          </header>
          <div class="evaluacion-dialog__list-body">
            @let selected = selectedSecciones$ | async;
            @if ((selected?.length ?? 0) === 0) {
              <p class="evaluacion-dialog__list-empty">
                Aún no se han añadido secciones a esta evaluación.
              </p>
            } @else {
              <ul class="evaluacion-dialog__items" role="list">
                @for (item of selected; track item.seccionCicloId) {
                  <li class="evaluacion-dialog__item" role="listitem">
                    <div class="evaluacion-dialog__item-info">
                      <span class="evaluacion-dialog__item-title">{{ item.label }}</span>
                      <div class="evaluacion-dialog__item-tags">
                        @if (item.registrado) {
                          <span class="evaluacion-dialog__chip evaluacion-dialog__chip--registered">
                            Registrada
                          </span>
                        } @else {
                          <span class="evaluacion-dialog__chip evaluacion-dialog__chip--new">
                            Nueva
                          </span>
                        }
                      </div>
                    </div>
                    <div class="evaluacion-dialog__item-actions evaluacion-dialog__item-actions--selected">
                      <mat-slide-toggle
                        color="primary"
                        [checked]="item.activo"
                        (change)="toggleSeccionActivo(item.seccionCicloId, $event.checked)"
                        [disabled]="isSaving$ | async"
                      >
                        {{ item.activo ? 'Activo' : 'Inactivo' }}
                      </mat-slide-toggle>
                      @if (!item.registrado) {
                        <button
                          mat-icon-button
                          color="warn"
                          type="button"
                          (click)="removeSeccion(item.seccionCicloId)"
                          [disabled]="isSaving$ | async"
                          aria-label="Quitar sección"
                        >
                          <mat-icon>delete_outline</mat-icon>
                        </button>
                      }
                    </div>
                  </li>
                }
              </ul>
            }
          </div>
        </section>
      </div>

      @if (
        form.controls['seccionCicloIds'].hasError('required') &&
        form.controls['seccionCicloIds'].touched
      ) {
        <div class="evaluacion-dialog__sections-error">
          Selecciona al menos una sección.
        </div>
      }
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="cancel()">Cancelar</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="isSaving$ | async">
      @if (isSaving$ | async) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
      }
      @if (!(isSaving$ | async)) {
        <span>
          {{ data.mode === 'create' ? 'Registrar' : 'Guardar cambios' }}
        </span>
      }
    </button>
  </mat-dialog-actions>
</form>
