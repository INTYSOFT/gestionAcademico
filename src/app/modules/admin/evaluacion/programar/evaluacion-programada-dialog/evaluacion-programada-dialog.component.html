<h2 mat-dialog-title>{{ dialogTitle }}</h2>

<form [formGroup]="form" class="evaluacion-dialog" (ngSubmit)="submitForm()">
  <mat-dialog-content>
    <div class="evaluacion-dialog__grid">
      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" maxlength="150" autocomplete="off" />
        <mat-hint align="end">{{ form.controls['nombre'].value?.length || 0 }}/150</mat-hint>
        @if (form.controls['nombre'].hasError('required')) {
          <mat-error>
            El nombre es obligatorio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de evaluación</mat-label>
        <mat-select formControlName="tipoEvaluacionId">
          @for (tipo of tipoEvaluaciones$ | async; track tipo) {
            <mat-option [value]="tipo.id">
              {{ tipo.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (form.controls['tipoEvaluacionId'].hasError('required')) {
          <mat-error>
            Selecciona un tipo de evaluación.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sede</mat-label>
        <mat-select formControlName="sedeId">
          @for (sede of sedes$ | async; track sede) {
            <mat-option [value]="sede.id">
              {{ sede.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (form.controls['sedeId'].hasError('required')) {
          <mat-error>
            Selecciona una sede.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Ciclo</mat-label>
        <mat-select formControlName="cicloId">
          @for (ciclo of filteredCiclos$ | async; track ciclo) {
            <mat-option [value]="ciclo.id">
              {{ ciclo.nombre }}
            </mat-option>
          }
        </mat-select>
        @if (isLoadingCiclos$ | async) {
          <div class="evaluacion-dialog__loading">
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Cargando ciclos...</span>
          </div>
        }
        @if (form.controls['cicloId'].hasError('required')) {
          <mat-error>
            Selecciona un ciclo válido.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de inicio</mat-label>
        <input matInput [matDatepicker]="fechaInicioPicker" formControlName="fechaInicio" />
        <mat-datepicker-toggle matSuffix [for]="fechaInicioPicker"></mat-datepicker-toggle>
        <mat-datepicker #fechaInicioPicker></mat-datepicker>
        @if (form.controls['fechaInicio'].hasError('required')) {
          <mat-error>
            Selecciona una fecha de inicio.
          </mat-error>
        }
        @if (form.controls['fechaInicio'].hasError('fechaDuplicada')) {
          <mat-error>
            Ya existe una evaluación programada con esta fecha y ciclo.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hora de inicio</mat-label>
        <input matInput type="time" formControlName="horaInicio" />
        @if (form.controls['horaInicio'].hasError('required')) {
          <mat-error>
            Ingresa la hora de inicio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hora de fin</mat-label>
        <input matInput type="time" formControlName="horaFin" />
        @if (form.controls['horaFin'].hasError('required')) {
          <mat-error>
            Ingresa la hora de fin.
          </mat-error>
        }
        @if (form.hasError('horarioInvalido')) {
          <mat-error>
            La hora de fin debe ser mayor a la hora de inicio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Carrera (opcional)</mat-label>
        <mat-select formControlName="carreraId">
          <mat-option [value]="null">Sin carrera</mat-option>
          @for (carrera of carreras$ | async; track carrera) {
            <mat-option [value]="carrera.id">
              {{ carrera.nombre }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="evaluacion-dialog__toggle">
        <mat-slide-toggle formControlName="activo">Activo</mat-slide-toggle>
      </div>
    </div>

    <mat-divider></mat-divider>

    <div class="evaluacion-dialog__sections">
      <div class="evaluacion-dialog__sections-header">
        <h3>Secciones</h3>
        @if (isLoadingSecciones$ | async) {
          <div class="evaluacion-dialog__sections-loader">
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Cargando secciones disponibles…</span>
          </div>
        }
      </div>

      <div class="evaluacion-dialog__sections-body">
        <div class="evaluacion-dialog__list evaluacion-dialog__list--available">
          <div class="evaluacion-dialog__list-header">
            <h4>Disponibles</h4>
            <span>Agrega secciones a la programación</span>
          </div>

          @if ((availableSeccionOptions$ | async) as disponibles) {
            <div class="evaluacion-dialog__list-items">
              @if (disponibles.length > 0) {
                @for (option of disponibles; track trackBySeccionCicloId) {
                  <button
                    mat-stroked-button
                    type="button"
                    class="evaluacion-dialog__list-item"
                    (click)="addSeccion(option)"
                  >
                    <span class="evaluacion-dialog__item-label">{{ option.label }}</span>
                    <mat-icon>add</mat-icon>
                  </button>
                }
              }
              @else {
                <p class="evaluacion-dialog__empty">No hay secciones disponibles.</p>
              }
            </div>
          }
        </div>

        <div class="evaluacion-dialog__list evaluacion-dialog__list--selected">
          <div class="evaluacion-dialog__list-header">
            <h4>Seleccionadas</h4>
            <span>Gestiona las secciones registradas</span>
          </div>

          @if ((selectedSecciones$ | async) as seleccionadas) {
            <div class="evaluacion-dialog__list-items">
              @if (seleccionadas.length > 0) {
                @for (item of seleccionadas; track trackBySeccionCicloId) {
                  <div class="evaluacion-dialog__selected-item">
                    <div class="evaluacion-dialog__selected-info">
                      <span class="evaluacion-dialog__item-label">{{ item.label }}</span>
                      @if (item.registrado) {
                        <span class="evaluacion-dialog__badge evaluacion-dialog__badge--registered">Registrada</span>
                      }
                      @if (!item.activoEnCiclo) {
                        <span class="evaluacion-dialog__badge evaluacion-dialog__badge--warning">Fuera de ciclo</span>
                      }
                    </div>
                    <div class="evaluacion-dialog__selected-actions">
                      <mat-slide-toggle
                        color="primary"
                        [checked]="item.activo"
                        (change)="toggleSeccionActivo(item, $event.checked)"
                        class="evaluacion-dialog__selected-toggle"
                      >
                        Activo
                      </mat-slide-toggle>
                      <button
                        mat-icon-button
                        type="button"
                        color="warn"
                        (click)="removeSeccion(item)"
                        [disabled]="item.registrado"
                        aria-label="Quitar sección"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              }
              @else {
                <p class="evaluacion-dialog__empty">No hay secciones seleccionadas.</p>
              }
            </div>
          }
        </div>
      </div>

      @if (
        form.controls['seccionCicloIds'].hasError('required') &&
        (form.controls['seccionCicloIds'].touched || form.touched)
      ) {
        <p class="evaluacion-dialog__error">Selecciona al menos una sección.</p>
      }
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="cancel()">Cancelar</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="isSaving$ | async">
      @if (isSaving$ | async) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
      }
      @if (!(isSaving$ | async)) {
        <span>
          {{ data.mode === 'create' ? 'Registrar' : 'Guardar cambios' }}
        </span>
      }
    </button>
  </mat-dialog-actions>
</form>
