<div class="flex min-w-0 flex-auto flex-col">
  <!-- Main -->
  <div class="flex-auto p-6 sm:p-10">
    <div class="h-400 max-h-400 min-h-400 rounded-2xl border-2 border-dashed border-gray-300">
      <div class="evaluacion-programar">
        <div class="header">
          <div class="header__titles">
            <h1 class="header__title">Evaluación programada</h1>
            <p class="header__subtitle">
              Gestiona las evaluaciones programadas filtrándolas por fecha de inicio.
            </p>
          </div>
          <button mat-flat-button color="primary" class="header__action" (click)="createProgramacion()">
            <mat-icon>add</mat-icon>
            Nueva programación
          </button>
        </div>

        <mat-card class="content">
          <form class="filters" [formGroup]="filtersForm" (submit)="$event.preventDefault()">
            <div class="filters__mode">
              <span class="filters__mode-label">Buscar por:</span>
              <mat-button-toggle-group formControlName="mode">
                <mat-button-toggle [value]="SearchMode.Range">Rango de fechas</mat-button-toggle>
                <mat-button-toggle [value]="SearchMode.Date">Fecha específica</mat-button-toggle>
              </mat-button-toggle-group>
            </div>

            @switch (filtersForm.controls.mode.value) {
              @case (SearchMode.Range) {
                <div class="filters__controls" formGroupName="range">
                  <mat-form-field appearance="outline" class="filters__field">
                    <mat-label>Fecha de inicio desde</mat-label>
                    <input
                      matInput
                      [matDatepicker]="startPicker"
                      formControlName="start"
                      placeholder="Selecciona la fecha inicial"
                      />
                      <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                      <mat-datepicker #startPicker></mat-datepicker>
                      @if (filtersForm.controls.range.controls.start.hasError('required')) {
                        <mat-error>
                          La fecha inicial es obligatoria.
                        </mat-error>
                      }
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="filters__field">
                      <mat-label>Fecha de inicio hasta</mat-label>
                      <input
                        matInput
                        [matDatepicker]="endPicker"
                        formControlName="end"
                        placeholder="Selecciona la fecha final"
                        />
                        <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                        <mat-datepicker #endPicker></mat-datepicker>
                        @if (filtersForm.controls.range.controls.end.hasError('required')) {
                          <mat-error>
                            La fecha final es obligatoria.
                          </mat-error>
                        }
                      </mat-form-field>
                    </div>
                  }
                  @case (SearchMode.Date) {
                    <div class="filters__controls">
                      <mat-form-field appearance="outline" class="filters__field filters__field--single">
                        <mat-label>Fecha de inicio</mat-label>
                        <input
                          matInput
                          [matDatepicker]="singleDatePicker"
                          formControlName="date"
                          placeholder="Selecciona la fecha"
                          />
                          <mat-datepicker-toggle matIconSuffix [for]="singleDatePicker"></mat-datepicker-toggle>
                          <mat-datepicker #singleDatePicker></mat-datepicker>
                          @if (filtersForm.controls.date.hasError('required')) {
                            <mat-error>
                              La fecha es obligatoria para la búsqueda.
                            </mat-error>
                          }
                        </mat-form-field>
                      </div>
                    }
                  }

                  @if (
                    filtersForm.controls.mode.value === SearchMode.Range &&
                    filtersForm.controls.range.hasError('invalidDateRange')
                    ) {
                    <mat-error
                      class="filters__error"
                      >
                      La fecha final debe ser igual o posterior a la fecha inicial.
                    </mat-error>
                  }
                </form>

                <section class="schedule">
                  <header class="schedule__header">
                    <h2 class="schedule__title">
                      @switch (filtersForm.controls.mode.value) {
                        @case (SearchMode.Range) {
                          @if (
                            filtersForm.controls.range.valid &&
                            filtersForm.controls.range.controls.start.value &&
                            filtersForm.controls.range.controls.end.value) {
                            Programaciones del
                            {{ formatDateControlValue(filtersForm.controls.range.controls.start.value) }}
                            al
                            {{ formatDateControlValue(filtersForm.controls.range.controls.end.value) }}
                          } @else {
                            Selecciona un criterio de búsqueda para visualizar las programaciones.
                          }
                        }
                        @case (SearchMode.Date) {
                          @if (filtersForm.controls.date.value) {
                            Programaciones del
                            {{ formatDateControlValue(filtersForm.controls.date.value) }}
                          } @else {
                            Selecciona un criterio de búsqueda para visualizar las programaciones.
                          }
                        }
                      }
                    </h2>
                  </header>

                  <div class="schedule__body">
                    @let isLoading = isLoadingEvaluaciones$ | async;
                    @let programaciones = programaciones$ | async;

                    @if (isLoading) {
                      <div class="schedule__loading">
                        <mat-progress-spinner diameter="56" mode="indeterminate"></mat-progress-spinner>
                      </div>
                    }

                    <ag-grid-angular
                      class="ag-theme-quartz schedule__grid"
                      [rowData]="programaciones ?? []"
                      [theme]="'legacy'"
                      [columnDefs]="columnDefs"
                      [defaultColDef]="defaultColDef"
                      [animateRows]="true"
                      [enableCellTextSelection]="true"
                      [suppressRowClickSelection]="true"
                      [domLayout]="'normal'"
                      [tooltipShowDelay]="0"
                      (gridReady)="onGridReady($event)"
                      (firstDataRendered)="onFirstDataRendered($event)"
                    ></ag-grid-angular>

                    @if (!isLoading && !(programaciones?.length ?? 0)) {
                      <div class="schedule__empty">
                        No hay programaciones registradas para el criterio seleccionado.
                      </div>
                    }
                  </div>
                </section>
              </mat-card>
            </div>
          </div>
        </div>
      </div>
