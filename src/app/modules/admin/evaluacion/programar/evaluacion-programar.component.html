<div class="flex min-w-0 flex-auto flex-col">
    <!-- Main -->
    <div class="flex-auto p-6 sm:p-10">
        <div class="h-400 max-h-400 min-h-400 rounded-2xl border-2 border-dashed border-gray-300">
            <div class="evaluacion-programar">
                <div class="header">
                    <div class="header__titles">
                        <h1 class="header__title">Evaluaci칩n programada</h1>
                        <p class="header__subtitle">
                            Gestiona las evaluaciones programadas filtr치ndolas por fecha de inicio.
                        </p>
                    </div>
                    <button mat-flat-button color="primary" (click)="createProgramacion()">
                        <mat-icon>add</mat-icon>
                        Nueva programaci칩n
                    </button>
                </div>

                <mat-card class="content">
                    <form class="filters" [formGroup]="dateRangeForm" (submit)="$event.preventDefault()">
                        <div class="filters__controls">
                            <mat-form-field appearance="outline" class="filters__field">
                                <mat-label>Fecha de inicio desde</mat-label>
                                <input
                                    matInput
                                    [matDatepicker]="startPicker"
                                    formControlName="start"
                                    placeholder="Selecciona la fecha inicial"
                                />
                                <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                                <mat-datepicker #startPicker></mat-datepicker>
                                <mat-error *ngIf="dateRangeForm.get('start')?.hasError('required')">
                                    La fecha inicial es obligatoria.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="filters__field">
                                <mat-label>Fecha de inicio hasta</mat-label>
                                <input
                                    matInput
                                    [matDatepicker]="endPicker"
                                    formControlName="end"
                                    placeholder="Selecciona la fecha final"
                                />
                                <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                                <mat-datepicker #endPicker></mat-datepicker>
                                <mat-error *ngIf="dateRangeForm.get('end')?.hasError('required')">
                                    La fecha final es obligatoria.
                                </mat-error>
                            </mat-form-field>
                        </div>
                        <mat-error class="filters__error" *ngIf="dateRangeForm.hasError('invalidDateRange')">
                            La fecha final debe ser igual o posterior a la fecha inicial.
                        </mat-error>
                    </form>

                    <section class="schedule">
                        <header class="schedule__header">
                            <h2 class="schedule__title">
                                <ng-container *ngIf="dateRangeForm.valid && dateRangeForm.value.start && dateRangeForm.value.end; else noRange">
                                    Programaciones del
                                    {{ formatDateControlValue(dateRangeForm.value.start) }}
                                    al
                                    {{ formatDateControlValue(dateRangeForm.value.end) }}
                                </ng-container>
                                <ng-template #noRange>
                                    Selecciona un rango de fechas para visualizar las programaciones.
                                </ng-template>
                            </h2>
                        </header>

                        <div class="schedule__body">
                            <div class="schedule__loading" *ngIf="isLoadingEvaluaciones$ | async">
                                <mat-progress-spinner diameter="56" mode="indeterminate"></mat-progress-spinner>
                            </div>

                            <ng-container *ngIf="!(isLoadingEvaluaciones$ | async)">
                                <mat-tree [dataSource]="treeDataSource" [treeControl]="treeControl" class="program-tree">
                                    <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
                                        <div class="tree-node tree-node--parent" matTreeNodePadding>
                                            <button
                                                mat-icon-button
                                                matTreeNodeToggle
                                                [attr.aria-label]="'Alternar ' + node.title"
                                            >
                                                <mat-icon>
                                                    {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
                                                </mat-icon>
                                            </button>
                                            <div class="tree-node__content">
                                                <div class="tree-node__header">
                                                    <span class="tree-node__title">{{ node.title }}</span>
                                                    <div class="tree-node__actions" *ngIf="node.evaluacionId">
                                                        <button
                                                            mat-icon-button
                                                            matTooltip="Editar programaci칩n"
                                                            (click)="editProgramacion(node.evaluacionId)"
                                                        >
                                                            <mat-icon>edit</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="tree-node__metadata" *ngIf="node.details?.length; else subtitleLines">
                                                    <div class="tree-node__metadata-item" *ngFor="let detail of node.details">
                                                        <span class="tree-node__metadata-label">{{ detail.label }}</span>
                                                        <span class="tree-node__metadata-value">{{ detail.value }}</span>
                                                    </div>
                                                </div>
                                                <ng-template #subtitleLines>
                                                    <div class="tree-node__subtitle" *ngFor="let line of node.subtitleLines">
                                                        {{ line }}
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </div>
                                        <div class="tree-node__children">
                                            <ng-container matTreeNodeOutlet></ng-container>
                                        </div>
                                    </mat-nested-tree-node>

                                    <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
                                        <div
                                            class="tree-node tree-node--child"
                                            [ngClass]="{ 'tree-node--info': node.status === 'info' }"
                                        >
                                            <mat-icon class="tree-node__bullet">
                                                {{ node.status === 'info' ? 'info' : 'label_important' }}
                                            </mat-icon>
                                            <div class="tree-node__content">
                                                <span class="tree-node__title">{{ node.title }}</span>
                                                <div class="tree-node__subtitle" *ngFor="let line of node.subtitleLines">
                                                    {{ line }}
                                                </div>
                                            </div>
                                        </div>
                                    </mat-tree-node>
                                </mat-tree>

                                <div *ngIf="!treeDataSource.data.length" class="schedule__empty">
                                    No hay programaciones registradas para el rango seleccionado.
                                </div>
                            </ng-container>
                        </div>
                    </section>
                </mat-card>
            </div>
        </div>
    </div>
</div>
