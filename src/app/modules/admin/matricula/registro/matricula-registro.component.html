<div class="flex min-w-0 flex-auto flex-col">
  <div class="flex-auto p-6 sm:p-10">

    <div class="matricula-registro">
      <mat-card class="matricula-card">
        <mat-card-header>
          <mat-card-title>Registro de matrícula</mat-card-title>
          <mat-card-subtitle>
            Selecciona la sede, ciclo y sección para iniciar el
            proceso
            de
            matrícula.
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="matriculaForm" class="matricula-form">
            <div
              class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
              <mat-form-field appearance="outline">
                <mat-label>Sede</mat-label>
                <mat-select formControlName="sedeId">
                  @for (sede of sedes$ | async; track trackById($index, sede)) {
                    <mat-option
                      [value]="sede.id">
                      {{ sede.nombre }}
                    </mat-option>
                  }
                </mat-select>
                @if (matriculaForm.get('sedeId')?.hasError('required')) {
                  <mat-error
                    >
                    Selecciona una sede.
                  </mat-error>
                }
              </mat-form-field>

              <div class="sm:col-span-1 xl:col-span-2">
                <mat-form-field appearance="outline"
                  class="w-full">
                  <mat-label>Ciclo</mat-label>
                  <mat-select formControlName="cicloId">
                    @for (ciclo of ciclosDisponibles$ | async; track trackById($index, ciclo)) {
                      <mat-option
                        [value]="ciclo.id">
                        {{ ciclo.nombre }}
                      </mat-option>
                    }
                  </mat-select>
                  @if (cicloSeleccionado) {
                    <mat-hint>
                      Apertura: {{
                      cicloSeleccionado?.fechaAperturaInscripcion
                      |
                      date:'mediumDate' }}
                      · Cierre: {{
                      cicloSeleccionado?.fechaCierreInscripcion
                      |
                      date:'mediumDate' }}
                    </mat-hint>
                  }
                  @if (matriculaForm.get('cicloId')?.hasError('required')) {
                    <mat-error
                      >
                      Selecciona un ciclo.
                    </mat-error>
                  }
                </mat-form-field>

              </div>

              <mat-form-field appearance="outline">
                <mat-label>Sección</mat-label>
                <mat-select formControlName="seccionCicloId">
                  @for (seccion of secciones$ | async; track trackById($index, seccion)) {
                    <mat-option
                      [value]="seccion.id">
                      {{ nombreSeccion(seccion) }}
                    </mat-option>
                  }
                </mat-select>
                @if (matriculaForm.get('seccionCicloId')?.hasError('required')) {
                  <mat-error
                    >
                    Selecciona una sección.
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Carrera</mat-label>
                <mat-select formControlName="carreraId">
                  @for (carrera of carreras$ | async; track trackById($index, carrera)) {
                    <mat-option
                      [value]="carrera.id">
                      {{ carrera.nombre }}
                    </mat-option>
                  }
                </mat-select>
                @if (matriculaForm.get('carreraId')?.hasError('required')) {
                  <mat-error
                    >
                    Selecciona una carrera.
                  </mat-error>
                }
              </mat-form-field>
            </div>

            @if (isLoadingSecciones$ | async) {
              <mat-progress-bar
              mode="indeterminate"></mat-progress-bar>
            }

            <div class="mt-6">
              <h3
              class="text-lg font-semibold text-gray-800">Alumno</h3>
              <div
                class="mt-3 flex flex-col gap-4 lg:flex-row lg:items-end">
                <mat-form-field appearance="outline"
                  class="flex-1">
                  <mat-label>Buscar alumno</mat-label>
                  <input
                    matInput
                    [matAutocomplete]="alumnoAuto"
                    [formControl]="alumnoSearchControl"
                    placeholder="Ingresa DNI o nombres" />
                    @if (alumnoSearchControl.value) {
                      <button
                        mat-icon-button
                        matSuffix
                        aria-label="Limpiar"
                        (click)="alumnoSearchControl.setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                    }
                  </mat-form-field>

                  <div class="flex flex-wrap gap-2">
                    <button mat-stroked-button color="primary"
                      type="button" (click)="crearAlumno()">
                      <mat-icon>person_add</mat-icon>
                      Registrar alumno
                    </button>
                    <button
                      mat-stroked-button
                      color="accent"
                      type="button"
                      (click)="gestionarApoderados()"
                      [disabled]="!alumnoSeleccionado">
                      <mat-icon>supervisor_account</mat-icon>
                      Gestionar apoderados
                    </button>
                  </div>
                </div>

                <mat-autocomplete
                  #alumnoAuto="matAutocomplete"
                  [displayWith]="alumnoDisplayFn"
                  (optionSelected)="onAlumnoSeleccionado($event)">
                  @for (alumno of alumnosFiltrados$ | async; track trackById($index, alumno)) {
                    <mat-option
                      [value]="alumno">
                      {{ mostrarAlumno(alumno) }}
                    </mat-option>
                  }
                </mat-autocomplete>

                @if (alumnoSeleccionado) {
                  <div
                    class="alumno-resumen">
                    <div class="resumen-item">
                      <span class="titulo">Documento</span>
                      <span>{{ alumnoSeleccionado?.dni }}</span>
                    </div>
                    <div class="resumen-item">
                      <span class="titulo">Nombre completo</span>
                      <span>{{ alumnoSeleccionado?.apellidos }} {{
                      alumnoSeleccionado?.nombres }}</span>
                    </div>
                    @if (alumnoSeleccionado?.correo) {
                      <div class="resumen-item"
                        >
                        <span class="titulo">Correo</span>
                        <span>{{ alumnoSeleccionado?.correo
                        }}</span>
                      </div>
                    }
                    @if (alumnoSeleccionado?.celular) {
                      <div class="resumen-item"
                        >
                        <span class="titulo">Celular</span>
                        <span>{{ alumnoSeleccionado?.celular
                        }}</span>
                      </div>
                    }
                  </div>
                }
              </div>

              <mat-divider class="my-6"></mat-divider>

              <div class="conceptos-section mt-6">
                <div class="conceptos-header">
                  <h3
                  class="text-lg font-semibold text-gray-800">Conceptos</h3>
                  <mat-form-field appearance="outline"
                    class="concepto-selector"
                    style="width: 100%;"
                    >
                    <mat-label>Agregar concepto</mat-label>
                    <mat-select
                      [formControl]="conceptoSelectorControl"
                      (selectionChange)="agregarConcepto($event.value)">
                      @for (concepto of conceptosDisponibles(); track trackById($index, concepto)) {
                        <mat-option
                          [value]="concepto.id">
                          {{ concepto.nombre }} · {{
                          concepto.precio |
                          currency:'PEN':'symbol':'1.2-2' }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>


                @if (conceptosFormArray.length > 0) {
                  <div
                    class="tabla-conceptos">
                    <table mat-table
                      [dataSource]="conceptosDataSource$ | async"
                      class="w-full">
                      <ng-container matColumnDef="concepto">
                        <th mat-header-cell
                        *matHeaderCellDef>Concepto</th>
                        <td mat-cell *matCellDef="let row">
                          {{
                          obtenerNombreConcepto(row.controls.conceptoId.value)
                          }}
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="cantidad">
                        <th mat-header-cell *matHeaderCellDef
                        class="text-right">Cantidad</th>
                        <td mat-cell *matCellDef="let row"
                          class="text-right">
                          <input type="number" min="1"
                            matInput
                            [formControl]="row.controls.cantidad" />
                          </td>
                        </ng-container>
                        <ng-container matColumnDef="precio">
                          <th mat-header-cell *matHeaderCellDef
                            class="text-right">Precio
                          unitario</th>
                          <td mat-cell *matCellDef="let row"
                            class="text-right">
                            <input type="number" min="0"
                              matInput
                              [formControl]="row.controls.precioUnit" />
                            </td>
                          </ng-container>
                          <ng-container matColumnDef="descuento">
                            <th mat-header-cell *matHeaderCellDef
                            class="text-right">Descuento</th>
                            <td mat-cell *matCellDef="let row"
                              class="text-right">
                              <input type="number" min="0"
                                matInput
                                [formControl]="row.controls.descuento" />
                              </td>
                            </ng-container>
                            <ng-container matColumnDef="subtotal">
                              <th mat-header-cell *matHeaderCellDef
                              class="text-right">Subtotal</th>
                              <td mat-cell *matCellDef="let row"
                                class="text-right">
                                {{ subtotal(row) |
                                currency:'PEN':'symbol':'1.2-2' }}
                              </td>
                            </ng-container>
                            <ng-container matColumnDef="acciones">
                              <th mat-header-cell
                              *matHeaderCellDef></th>
                              <td mat-cell
                                *matCellDef="let row; let i = index"
                                class="text-right">
                                <button
                                  mat-icon-button
                                  color="warn"
                                  aria-label="Eliminar concepto"
                                  (click)="eliminarConcepto(i)">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </td>
                            </ng-container>
                            <tr mat-header-row
                            *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row
                              *matRowDef="let row; columns: displayedColumns"
                            [formGroup]="row"></tr>
                          </table>
                        </div>
                      } @else {
                        <div class="mensaje-vacio">
                          Selecciona una sección para precargar el
                          concepto de
                          matrícula y agregar otros conceptos.
                        </div>
                      }
                    </div>
                  </form>
                </mat-card-content>
                <mat-card-actions class="acciones">
                  <div class="totales">
                    <span>Total a pagar:</span>
                    <strong>{{ total$ | async |
                      currency:'PEN':'symbol':'1.2-2'
                    }}</strong>
                  </div>
                  <div class="botones">
                    <button mat-button type="button"
                      (click)="nuevaMatricula()">
                      <mat-icon>refresh</mat-icon>
                      Nueva matrícula
                    </button>
                    <button
                      mat-flat-button
                      color="primary"
                      type="button"
                      (click)="registrarMatricula()"
                            [disabled]="
                        matriculaForm.invalid ||
                        conceptosFormArray.length === 0 ||
                        (isSaving$ | async)
                    ">
                      <mat-icon>save</mat-icon>
                      Registrar matrícula
                    </button>
                  </div>
                </mat-card-actions>
              </mat-card>
            </div>
          </div>
        </div>