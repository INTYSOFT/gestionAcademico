<h2 mat-dialog-title>Editar sección del ciclo</h2>

@if (isSaving$ | async) {
  <mat-progress-bar
    mode="indeterminate"
  color="primary"></mat-progress-bar>
}

<mat-dialog-content>
  @if (hasAvailableSecciones() && hasAvailableNiveles()) {
    <form class="edit-seccion-dialog__form" [formGroup]="form">
      <mat-form-field appearance="outline">
        <mat-label>Sección</mat-label>
        <mat-select formControlName="seccionId" placeholder="Seleccionar sección">
          @for (seccion of availableSecciones; track seccion) {
            <mat-option [value]="seccion.id">
              {{ seccion.nombre }} (Capacidad: {{ seccion.capacidad }})
              @if (!seccion.activo) {
                — Inactiva
              }
            </mat-option>
          }
        </mat-select>
        @if (form.get('seccionId')?.hasError('required')) {
          <mat-error>
            Selecciona una sección.
          </mat-error>
        }
        @if (form.get('seccionId')?.hasError('duplicate')) {
          <mat-error>
            La sección seleccionada ya está registrada en este ciclo.
          </mat-error>
        }
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Nivel</mat-label>
        <mat-select formControlName="nivelId" placeholder="Seleccionar nivel">
          @for (nivel of niveles; track nivel) {
            <mat-option [value]="nivel.id">
              {{ nivel.nombre }}
              @if (!nivel.activo) {
                — Inactivo
              }
            </mat-option>
          }
        </mat-select>
        @if (form.get('nivelId')?.hasError('required')) {
          <mat-error>
            Selecciona un nivel.
          </mat-error>
        }
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Capacidad</mat-label>
        <input
          matInput
          type="number"
          min="0"
          formControlName="capacidad"
          placeholder="Capacidad de la sección" />
          @if (form.get('capacidad')?.hasError('required')) {
            <mat-error>
              La capacidad es obligatoria.
            </mat-error>
          }
          @if (form.get('capacidad')?.hasError('min')) {
            <mat-error>
              La capacidad no puede ser negativa.
            </mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Precio</mat-label>
          <input
            matInput
            type="number"
            min="0"
            step="0.01"
            formControlName="precio"
            placeholder="Precio de la sección" />
            @if (form.get('precio')?.hasError('required')) {
              <mat-error>
                El precio es obligatorio.
              </mat-error>
            }
            @if (form.get('precio')?.hasError('min')) {
              <mat-error>
                El precio no puede ser negativo.
              </mat-error>
            }
          </mat-form-field>
          <mat-slide-toggle formControlName="activo">Sección activa</mat-slide-toggle>
        </form>
      } @else {
        <p class="edit-seccion-dialog__empty">
          No hay secciones o niveles disponibles para actualizar.
        </p>
      }

    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button type="button" (click)="cancel()">Cancelar</button>
      <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="save()"
        [disabled]="
            !hasAvailableSecciones() ||
            !hasAvailableNiveles() ||
            (form.invalid && hasAvailableSecciones() && hasAvailableNiveles()) ||
            (isSaving$ | async)
        ">
        Guardar
      </button>
    </mat-dialog-actions>
