<h2 mat-dialog-title>
  {{ data.alumno ? 'Editar alumno' : 'Nuevo alumno' }}
</h2>

<form [formGroup]="form" (ngSubmit)="save()" class="alumno-form">
  <mat-dialog-content>
    <div class="alumno-form__status">
      @if (isLoadingColegios$ | async) {
        <mat-progress-bar
          mode="indeterminate"
        ></mat-progress-bar>
      }

      @if (colegiosLoadError$ | async) {
        <div
          class="alumno-form__error"
          >
          <span>
            No se pudieron cargar los colegios. Intente nuevamente.
          </span>
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="recargarColegios()"
            >
            Reintentar
          </button>
        </div>
      }
    </div>

    <div class="alumno-form__grid">
      <mat-form-field appearance="outline">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" maxlength="12" />
        @if (form.controls.dni.hasError('required')) {
          <mat-error>
            El DNI es obligatorio.
          </mat-error>
        }
        @if (form.controls.dni.hasError('minlength')) {
          <mat-error>
            Debe tener al menos 8 dígitos.
          </mat-error>
        }
        @if (form.controls.dni.hasError('maxlength')) {
          <mat-error>
            No puede superar los 12 dígitos.
          </mat-error>
        }
        @if (form.controls.dni.hasError('pattern')) {
          <mat-error>
            Solo se permiten números.
          </mat-error>
        }
        @if (form.controls.dni.hasError('dniTaken')) {
          <mat-error>
            Ya existe un alumno registrado con este DNI.
          </mat-error>
        }
        @if (form.controls.dni.hasError('dniLookupFailed')) {
          <mat-error>
            No se pudo validar el DNI. Intente nuevamente.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Apellidos</mat-label>
        <input matInput formControlName="apellidos" />
        @if (form.controls.apellidos.hasError('required')) {
          <mat-error>
            Los apellidos son obligatorios.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nombres</mat-label>
        <input matInput formControlName="nombres" />
        @if (form.controls.nombres.hasError('required')) {
          <mat-error>
            Los nombres son obligatorios.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de nacimiento</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento" />
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        @if (form.controls.fechaNacimiento.hasError('futureDate')) {
          <mat-error>
            La fecha no puede ser futura.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Celular</mat-label>
        <input matInput formControlName="celular" />
        @if (form.controls.celular.hasError('pattern')) {
          <mat-error>
            Ingrese entre 9 y 15 dígitos.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Correo electrónico</mat-label>
        <input matInput formControlName="correo" />
        @if (form.controls.correo.hasError('email')) {
          <mat-error>
            Ingrese un correo válido.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Colegio de procedencia</mat-label>
        <mat-select
          formControlName="colegioId"
          [disabled]="isLoadingColegios$ | async"
          >
          <mat-option value="" disabled>Seleccione</mat-option>
          @if (colegios$ | async; as colegios) {
            @for (colegio of colegios; track trackById($index, colegio)) {
              <mat-option
                [value]="colegio.id"
                >
                {{ colegio.nombre }}
              </mat-option>
            }
            @if (
              !(isLoadingColegios$ | async) &&
              !(
              colegiosLoadError$ | async
              ) &&
              colegios.length === 0
              ) {
              <mat-hint
                >
                No hay colegios activos disponibles.
              </mat-hint>
            }
          }
        </mat-select>
        @if (form.controls.colegioId.hasError('required')) {
          <mat-error>
            Seleccione un colegio.
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="alumno-form__full">
        <mat-label>Dirección</mat-label>
        <input matInput formControlName="direccion" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="alumno-form__full">
        <mat-label>Observación</mat-label>
        <textarea matInput rows="3" formControlName="observacion"></textarea>
      </mat-form-field>
    </div>

    <mat-checkbox formControlName="activo">Activo</mat-checkbox>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="cancel()">Cancelar</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="isSaving$ | async">
      @if (isSaving$ | async) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
      }
      <span>
        {{ data.alumno ? 'Guardar cambios' : 'Registrar' }}
      </span>
    </button>
  </mat-dialog-actions>
</form>
