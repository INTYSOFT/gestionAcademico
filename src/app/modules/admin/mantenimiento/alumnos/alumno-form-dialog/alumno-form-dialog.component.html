<h2 mat-dialog-title>
    {{ data.alumno ? 'Editar alumno' : 'Nuevo alumno' }}
</h2>

<form [formGroup]="form" (ngSubmit)="save()" class="alumno-form">
    <mat-dialog-content>
        <div class="alumno-form__status">
            <mat-progress-bar
                *ngIf="isLoadingColegios$ | async"
                mode="indeterminate"
            ></mat-progress-bar>

            <div
                class="alumno-form__error"
                *ngIf="colegiosLoadError$ | async"
            >
                <span>
                    No se pudieron cargar los colegios. Intente nuevamente.
                </span>
                <button
                    mat-stroked-button
                    color="primary"
                    type="button"
                    (click)="recargarColegios()"
                >
                    Reintentar
                </button>
            </div>
        </div>

        <div class="alumno-form__grid">
            <mat-form-field appearance="outline">
                <mat-label>DNI</mat-label>
                <input matInput formControlName="dni" maxlength="12" />
                <mat-error *ngIf="form.controls.dni.hasError('required')">
                    El DNI es obligatorio.
                </mat-error>
                <mat-error *ngIf="form.controls.dni.hasError('minlength')">
                    Debe tener al menos 8 dígitos.
                </mat-error>
                <mat-error *ngIf="form.controls.dni.hasError('maxlength')">
                    No puede superar los 12 dígitos.
                </mat-error>
                <mat-error *ngIf="form.controls.dni.hasError('pattern')">
                    Solo se permiten números.
                </mat-error>
                <mat-error *ngIf="form.controls.dni.hasError('dniTaken')">
                    Ya existe un alumno registrado con este DNI.
                </mat-error>
                <mat-error *ngIf="form.controls.dni.hasError('dniLookupFailed')">
                    No se pudo validar el DNI. Intente nuevamente.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Apellidos</mat-label>
                <input matInput formControlName="apellidos" />
                <mat-error *ngIf="form.controls.apellidos.hasError('required')">
                    Los apellidos son obligatorios.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Nombres</mat-label>
                <input matInput formControlName="nombres" />
                <mat-error *ngIf="form.controls.nombres.hasError('required')">
                    Los nombres son obligatorios.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Fecha de nacimiento</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento" />
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="form.controls.fechaNacimiento.hasError('futureDate')">
                    La fecha no puede ser futura.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Celular</mat-label>
                <input matInput formControlName="celular" />
                <mat-error *ngIf="form.controls.celular.hasError('pattern')">
                    Ingrese entre 9 y 15 dígitos.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Correo electrónico</mat-label>
                <input matInput formControlName="correo" />
                <mat-error *ngIf="form.controls.correo.hasError('email')">
                    Ingrese un correo válido.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Colegio de procedencia</mat-label>
                <mat-select
                    formControlName="colegioId"
                    [disabled]="isLoadingColegios$ | async"
                >
                    <mat-option value="" disabled>Seleccione</mat-option>
                    <ng-container *ngIf="colegios$ | async as colegios">
                        <mat-option
                            *ngFor="let colegio of colegios; trackBy: trackById"
                            [value]="colegio.id"
                        >
                            {{ colegio.nombre }}
                        </mat-option>
                        <mat-hint
                            *ngIf="
                                !(isLoadingColegios$ | async) &&
                                !(
                                    colegiosLoadError$ | async
                                ) &&
                                colegios.length === 0
                            "
                        >
                            No hay colegios activos disponibles.
                        </mat-hint>
                    </ng-container>
                </mat-select>
                <mat-error *ngIf="form.controls.colegioId.hasError('required')">
                    Seleccione un colegio.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="alumno-form__full">
                <mat-label>Dirección</mat-label>
                <input matInput formControlName="direccion" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="alumno-form__full">
                <mat-label>Observación</mat-label>
                <textarea matInput rows="3" formControlName="observacion"></textarea>
            </mat-form-field>
        </div>

        <mat-checkbox formControlName="activo">Activo</mat-checkbox>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
        <button mat-button type="button" (click)="cancel()">Cancelar</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="isSaving$ | async">
            <mat-progress-spinner
                *ngIf="isSaving$ | async"
                diameter="20"
                mode="indeterminate"
            ></mat-progress-spinner>
            <span>
                {{ data.alumno ? 'Guardar cambios' : 'Registrar' }}
            </span>
        </button>
    </mat-dialog-actions>
</form>
