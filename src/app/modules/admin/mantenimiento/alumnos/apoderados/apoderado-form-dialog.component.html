<h2 mat-dialog-title>Buscar o registrar apoderado</h2>

<mat-dialog-content class="apoderado-dialog">
    <section class="apoderado-dialog__section">
        <h3>1. Buscar apoderado existente</h3>
        <mat-form-field appearance="outline" class="apoderado-dialog__search">
            <mat-label>Documento, apellidos o nombres</mat-label>
            <input matInput [formControl]="searchControl" />
        </mat-form-field>

        <mat-progress-spinner
            *ngIf="isLoading$ | async"
            diameter="32"
            mode="indeterminate"
        ></mat-progress-spinner>

        <mat-nav-list *ngIf="!(isLoading$ | async)">
            <a
                mat-list-item
                *ngFor="let apoderado of filteredApoderados$ | async; trackBy: trackByApoderadoId"
                (click)="selectApoderado(apoderado)"
                [class.apoderado-dialog__item--selected]="isSelected(apoderado)"
            >
                <div matLine>{{ apoderado.apellidos }} {{ apoderado.nombres }}</div>
                <div matLine class="apoderado-dialog__item-subtitle">
                    DNI: {{ apoderado.documento || '—' }} · Celular:
                    {{ apoderado.celular || '—' }} · Correo:
                    {{ apoderado.correo || '—' }}
                </div>
            </a>
        </mat-nav-list>

        <p *ngIf="!(isLoading$ | async) && !(filteredApoderados$ | async)?.length" class="apoderado-dialog__empty">
            No se encontraron coincidencias.
        </p>
    </section>

    <section class="apoderado-dialog__section">
        <h3>2. Registrar nuevo apoderado</h3>
        <form [formGroup]="createForm" (ngSubmit)="createApoderado()" class="apoderado-dialog__form">
            <mat-form-field appearance="outline">
                <mat-label>Apellidos</mat-label>
                <input matInput formControlName="apellidos" />
                <mat-error *ngIf="createForm.controls.apellidos.hasError('required')">
                    Campo obligatorio.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Nombres</mat-label>
                <input matInput formControlName="nombres" />
                <mat-error *ngIf="createForm.controls.nombres.hasError('required')">
                    Campo obligatorio.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Documento</mat-label>
                <input matInput formControlName="documento" maxlength="15" />
                <mat-error *ngIf="createForm.controls.documento.hasError('required')">
                    Campo obligatorio.
                </mat-error>
                <mat-error *ngIf="createForm.controls.documento.hasError('minlength')">
                    Debe tener al menos 8 dígitos.
                </mat-error>
                <mat-error *ngIf="createForm.controls.documento.hasError('pattern')">
                    Solo se permiten números.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Celular</mat-label>
                <input matInput formControlName="celular" />
                <mat-error *ngIf="createForm.controls.celular.hasError('pattern')">
                    Ingrese entre 9 y 15 dígitos.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Correo</mat-label>
                <input matInput formControlName="correo" />
                <mat-error *ngIf="createForm.controls.correo.hasError('email')">
                    Correo inválido.
                </mat-error>
            </mat-form-field>

            <button mat-stroked-button color="primary" type="submit" [disabled]="isCreating$ | async">
                <mat-progress-spinner
                    *ngIf="isCreating$ | async"
                    diameter="20"
                    mode="indeterminate"
                ></mat-progress-spinner>
                <span>Registrar apoderado</span>
            </button>
        </form>
    </section>

    <section class="apoderado-dialog__section">
        <h3>3. Seleccionar parentesco</h3>
        <mat-form-field appearance="outline" class="apoderado-dialog__select">
            <mat-label>Parentesco</mat-label>
            <mat-select [formControl]="selectedParentesco">
                <mat-option value="" disabled>Seleccione</mat-option>
                <mat-option
                    *ngFor="let parentesco of parentescos$ | async; trackBy: trackByParentescoId"
                    [value]="parentesco.id"
                >
                    {{ parentesco.nombre }}
                </mat-option>
            </mat-select>
            <mat-error *ngIf="selectedParentesco.invalid && selectedParentesco.touched">
                Seleccione un parentesco.
            </mat-error>
        </mat-form-field>
    </section>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button type="button" (click)="cancel()">Cancelar</button>
    <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="save()"
        [disabled]="!(selectedApoderado$ | async) || selectedParentesco.invalid"
    >
        Vincular apoderado
    </button>
</mat-dialog-actions>
