<h2 mat-dialog-title>Buscar o registrar apoderado</h2>

<mat-dialog-content class="apoderado-dialog">
  <section class="apoderado-dialog__section">
    <h3>1. Buscar apoderado existente</h3>
    <mat-form-field appearance="outline" class="apoderado-dialog__search">
      <mat-label>Documento, apellidos o nombres</mat-label>
      <input matInput [formControl]="searchControl" />
    </mat-form-field>

    @if (isLoading$ | async) {
      <mat-progress-spinner
        diameter="32"
        mode="indeterminate"
      ></mat-progress-spinner>
    }

    @if (!(isLoading$ | async)) {
      <div class="apoderado-dialog__grid-wrapper">
        <ag-grid-angular
          class="ag-theme-material apoderado-dialog__grid"
          [theme]="'legacy'"
          [columnDefs]="columnDefs"
          [defaultColDef]="defaultColDef"
          [rowData]="filteredApoderados$ | async"
          [rowSelection]="rowSelection"
          [rowClassRules]="rowClassRules"
          [domLayout]="'autoHeight'"
          [suppressCellFocus]="true"
          [getRowId]="getRowId"
          (gridReady)="onGridReady($event)"
          (selectionChanged)="onSelectionChanged()"
        ></ag-grid-angular>
      </div>
    }

    @if (showCreateSection$ | async) {
      <p class="apoderado-dialog__empty">
        No se encontraron coincidencias.
      </p>
    }
  </section>

  @if (showCreateSection$ | async) {
    <section
      class="apoderado-dialog__section"
      >
      <h3>2. Registrar nuevo apoderado</h3>
      <form [formGroup]="createForm" (ngSubmit)="createApoderado()" class="apoderado-dialog__form">
        <mat-form-field appearance="outline">
          <mat-label>Apellidos</mat-label>
          <input matInput formControlName="apellidos" />
          @if (createForm.controls.apellidos.hasError('required')) {
            <mat-error>
              Campo obligatorio.
            </mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Nombres</mat-label>
          <input matInput formControlName="nombres" />
          @if (createForm.controls.nombres.hasError('required')) {
            <mat-error>
              Campo obligatorio.
            </mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Documento</mat-label>
          <input matInput formControlName="documento" maxlength="15" />
          @if (createForm.controls.documento.hasError('required')) {
            <mat-error>
              Campo obligatorio.
            </mat-error>
          }
          @if (createForm.controls.documento.hasError('minlength')) {
            <mat-error>
              Debe tener al menos 8 dígitos.
            </mat-error>
          }
          @if (createForm.controls.documento.hasError('pattern')) {
            <mat-error>
              Solo se permiten números.
            </mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Celular</mat-label>
          <input matInput formControlName="celular" />
          @if (createForm.controls.celular.hasError('pattern')) {
            <mat-error>
              Ingrese entre 9 y 15 dígitos.
            </mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Correo</mat-label>
          <input matInput formControlName="correo" />
          @if (createForm.controls.correo.hasError('email')) {
            <mat-error>
              Correo inválido.
            </mat-error>
          }
        </mat-form-field>
        <button mat-stroked-button color="primary" type="submit" [disabled]="isCreating$ | async">
          @if (isCreating$ | async) {
            <mat-progress-spinner
              diameter="20"
              mode="indeterminate"
            ></mat-progress-spinner>
          }
          <span>Registrar apoderado</span>
        </button>
      </form>
    </section>
  }

  <section class="apoderado-dialog__section">
    <h3>{{ (parentescoStep$ | async) }}. Seleccionar parentesco</h3>
    <mat-form-field appearance="outline" class="apoderado-dialog__select">
      <mat-label>Parentesco</mat-label>
      <mat-select [formControl]="selectedParentesco">
        <mat-option value="" disabled>Seleccione</mat-option>
        @for (parentesco of parentescos$ | async; track trackByParentescoId($index, parentesco)) {
          <mat-option
            [value]="parentesco.id"
            >
            {{ parentesco.nombre }}
          </mat-option>
        }
      </mat-select>
      @if (selectedParentesco.invalid && selectedParentesco.touched) {
        <mat-error>
          Seleccione un parentesco.
        </mat-error>
      }
    </mat-form-field>
  </section>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button type="button" (click)="cancel()">Cancelar</button>
  <button
    mat-flat-button
    color="primary"
    type="button"
    (click)="save()"
    [disabled]="!(selectedApoderado$ | async) || selectedParentesco.invalid"
    >
    Vincular apoderado
  </button>
</mat-dialog-actions>
