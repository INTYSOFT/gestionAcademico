<h2 mat-dialog-title class="text-lg font-semibold">
    {{ data.alumno ? 'Editar alumno' : 'Registrar alumno' }}
</h2>

<div mat-dialog-content class="flex flex-col gap-6 py-2">
    <mat-progress-bar *ngIf="isSaving$ | async" mode="indeterminate"></mat-progress-bar>

    <form
        id="alumnoForm"
        [formGroup]="form"
        class="flex flex-col gap-6"
        (ngSubmit)="submit()"
    >
        <section class="flex flex-col gap-4">
            <h3 class="text-base font-semibold">Datos del alumno</h3>
            <div class="grid gap-4 md:grid-cols-2">
                <mat-form-field appearance="outline">
                    <mat-label>DNI</mat-label>
                    <input matInput formControlName="dni" maxlength="12" />
                    <mat-error *ngIf="form.get('dni')?.hasError('required')">El DNI es obligatorio.</mat-error>
                    <mat-error *ngIf="form.get('dni')?.hasError('maxlength')">
                        Máximo 12 caracteres.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Apellidos</mat-label>
                    <input matInput formControlName="apellidos" />
                    <mat-error *ngIf="form.get('apellidos')?.hasError('maxlength')">
                        Máximo 150 caracteres.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Nombres</mat-label>
                    <input matInput formControlName="nombres" />
                    <mat-error *ngIf="form.get('nombres')?.hasError('maxlength')">
                        Máximo 150 caracteres.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Fecha de nacimiento</mat-label>
                    <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento" />
                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Celular</mat-label>
                    <input matInput formControlName="celular" />
                    <mat-error *ngIf="form.get('celular')?.hasError('maxlength')">
                        Máximo 15 caracteres.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Correo</mat-label>
                    <input matInput type="email" formControlName="correo" />
                    <mat-error *ngIf="form.get('correo')?.hasError('email')">Correo no válido.</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Código de ubigeo</mat-label>
                    <input matInput formControlName="ubigeoCode" maxlength="6" />
                    <mat-error *ngIf="form.get('ubigeoCode')?.hasError('minlength') || form.get('ubigeoCode')?.hasError('maxlength')">
                        Debe tener 6 caracteres.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Colegio de origen</mat-label>
                    <input matInput formControlName="colegioOrigen" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Carrera actual (ID)</mat-label>
                    <input matInput formControlName="carreraActualId" type="number" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>URL de foto</mat-label>
                    <input matInput formControlName="fotoUrl" />
                </mat-form-field>
            </div>

            <mat-slide-toggle formControlName="activo">Activo</mat-slide-toggle>
        </section>

        <mat-divider></mat-divider>

        <section class="flex flex-col gap-4" formArrayName="apoderados">
            <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold">Apoderados</h3>
                <button mat-stroked-button type="button" (click)="addApoderado()">
                    <mat-icon class="mr-2">add</mat-icon>
                    Agregar apoderado
                </button>
            </div>

            <ng-container *ngFor="let apoderado of apoderados.controls; let i = index; trackBy: trackByApoderado">
                <div class="rounded-lg border border-gray-200 p-4 shadow-sm" [formGroupName]="i">
                    <div class="mb-4 flex items-center justify-between">
                        <h4 class="text-sm font-semibold uppercase">Apoderado {{ i + 1 }}</h4>
                        <button
                            mat-icon-button
                            type="button"
                            matTooltip="Eliminar apoderado"
                            (click)="removeApoderado(i)"
                            [disabled]="apoderados.length === 1"
                            aria-label="Eliminar apoderado"
                        >
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                    <div class="grid gap-4 md:grid-cols-2">
                        <mat-form-field appearance="outline">
                            <mat-label>Documento</mat-label>
                            <input matInput formControlName="documento" maxlength="15" />
                            <mat-error *ngIf="apoderado.get('documento')?.hasError('required')">
                                El documento es obligatorio.
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Relación</mat-label>
                            <input matInput formControlName="relacion" maxlength="50" />
                            <mat-error *ngIf="apoderado.get('relacion')?.hasError('required')">
                                La relación es obligatoria.
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Apellidos</mat-label>
                            <input matInput formControlName="apellidos" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Nombres</mat-label>
                            <input matInput formControlName="nombres" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Celular</mat-label>
                            <input matInput formControlName="celular" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Correo</mat-label>
                            <input matInput formControlName="correo" type="email" />
                            <mat-error *ngIf="apoderado.get('correo')?.hasError('email')">
                                Correo no válido.
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <mat-slide-toggle formControlName="activo">Activo</mat-slide-toggle>
                </div>
            </ng-container>
        </section>
    </form>
</div>

<div mat-dialog-actions class="flex justify-end gap-2">
    <button mat-button type="button" (click)="cancel()">Cancelar</button>
    <button
        mat-flat-button
        color="primary"
        type="submit"
        form="alumnoForm"
        [disabled]="form.invalid || (isSaving$ | async)"
    >
        {{ data.alumno ? 'Actualizar' : 'Registrar' }}
    </button>
</div>
